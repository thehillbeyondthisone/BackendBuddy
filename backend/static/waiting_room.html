<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting Room</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-bg: #0a0a0a;
            --color-surface: #1a1a1a;
            --color-primary: #00ff88;
            --color-warning: #ffcc00;
            --color-text: #ffffff;
            --color-text-dim: #888888;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: var(--color-surface);
            border: 3px solid var(--color-primary);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 8px 8px 0 rgba(0, 255, 136, 0.3);
        }

        .title {
            font-size: 24px;
            color: var(--color-primary);
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        .position-box {
            background: var(--color-bg);
            border: 2px solid var(--color-warning);
            padding: 30px;
            margin-bottom: 30px;
        }

        .position-label {
            font-size: 14px;
            color: var(--color-text-dim);
            margin-bottom: 10px;
        }

        .position-number {
            font-size: 72px;
            color: var(--color-warning);
            font-weight: bold;
        }

        .status {
            font-size: 18px;
            color: var(--color-primary);
            margin-bottom: 20px;
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .info {
            font-size: 12px;
            color: var(--color-text-dim);
            margin-top: 20px;
            line-height: 1.6;
        }

        .queue-info {
            margin-top: 20px;
            padding: 15px;
            background: var(--color-bg);
            border: 1px solid #333;
        }

        .queue-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .queue-info-row:last-child {
            margin-bottom: 0;
        }

        .label {
            color: var(--color-text-dim);
        }

        .value {
            color: var(--color-primary);
        }

        .error {
            color: #ff4444;
            margin-top: 10px;
            display: none;
        }

        .redirecting {
            color: var(--color-primary);
            font-size: 18px;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="title">⏳ Waiting Room</h1>

        <div class="position-box">
            <div class="position-label">YOUR POSITION</div>
            <div class="position-number" id="position">-</div>
        </div>

        <div class="status">
            <span class="blink">●</span> <span id="status-text">CONNECTING...</span>
        </div>

        <div class="queue-info">
            <div class="queue-info-row">
                <span class="label">TOTAL IN QUEUE:</span>
                <span class="value" id="queue-length">-</span>
            </div>
            <div class="queue-info-row">
                <span class="label">ESTIMATED WAIT:</span>
                <span class="value" id="estimated-wait">-</span>
            </div>
            <div class="queue-info-row">
                <span class="label">SESSION:</span>
                <span class="value" id="session-id">-</span>
            </div>
        </div>

        <div class="info">
            You will be automatically redirected when a spot opens up.<br>
            Please keep this tab open.
        </div>

        <div class="error" id="error"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let sessionId = null;
        let pollInterval = null;

        // Get session ID from injected variable (preferred) or cookie/URL fallback
        function getSessionId() {
            // Check for injected session ID (set by backend)
            if (window.BB_SESSION_ID) {
                return window.BB_SESSION_ID;
            }

            // Fallback: check cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'bb_session_id') {
                    return value;
                }
            }
            // Fallback: check URL param
            const params = new URLSearchParams(window.location.search);
            return params.get('session_id');
        }

        // Update UI with queue status
        function updateUI(data) {
            document.getElementById('position').textContent = data.position || '-';
            document.getElementById('queue-length').textContent = data.queue_length || '-';
            document.getElementById('session-id').textContent = (sessionId || '-').substring(0, 8) + '...';

            if (data.estimated_wait) {
                const minutes = Math.ceil(data.estimated_wait / 60);
                document.getElementById('estimated-wait').textContent = `~${minutes} min`;
            } else {
                document.getElementById('estimated-wait').textContent = '-';
            }

            if (data.status === 'active') {
                document.getElementById('status-text').textContent = 'ACCESS GRANTED!';
                document.getElementById('status-text').classList.add('redirecting');
                document.getElementById('position').textContent = '✓';

                // Redirect to the app
                setTimeout(() => {
                    window.location.href = '/preview/';
                }, 1000);
            } else {
                document.getElementById('status-text').textContent = 'WAITING FOR ACCESS...';
            }
        }

        // Poll for status updates
        async function pollStatus() {
            if (!sessionId) {
                document.getElementById('error').textContent = 'No session ID found';
                document.getElementById('error').style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/queue/status/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    updateUI(data);

                    // Also send heartbeat
                    fetch(`${API_BASE}/api/queue/heartbeat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: sessionId })
                    });
                } else {
                    // Session not found, try to rejoin
                    const joinResp = await fetch(`${API_BASE}/api/queue/join`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    if (joinResp.ok) {
                        const joinData = await joinResp.json();
                        updateUI(joinData);
                    }
                }
            } catch (err) {
                console.error('Poll error:', err);
                document.getElementById('error').textContent = 'Connection error. Retrying...';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Initialize
        function init() {
            sessionId = getSessionId();

            if (!sessionId) {
                document.getElementById('status-text').textContent = 'SESSION ERROR';
                document.getElementById('error').textContent = 'No session found. Please refresh the main page.';
                document.getElementById('error').style.display = 'block';
                return;
            }

            // Initial poll
            pollStatus();

            // Poll every 2 seconds
            pollInterval = setInterval(pollStatus, 2000);
        }

        init();
    </script>
</body>

</html>